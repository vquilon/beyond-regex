class NFA{constructor(e){for(var t,c=Kit(),r={},a=(e=e.compact?this._expandNames(e):e).trans,i={},o=0,s=e.accepts.length;o<s;o++)r[e.accepts[o]]=!0;for(o=0,s=a.length;o<s;o++)(t=a[o]).charset?t.ranges="string"==typeof t.charset?c.parseCharset(t.charset):t.charset:t.eMove=!0,t.from.forEach(function(e){e=i[e]=i[e]||{eMoveStates:[],eMove:[],charMove:{},trans:[],ranges:[]},t.eMove?e.eMoveStates=e.eMoveStates.concat(t.to):e.ranges=e.ranges.concat(t.ranges),e.trans.push(t)});Object.keys(i).forEach(function(e){var t=i[e],o=t.trans,s=t.charMove,r=t.eMove,a=t.ranges,n=(e=c.classify(a)).map;o.forEach(function(t){t.eMove?t.to.forEach(function(e){r.push({to:e,action:t.action,assert:t.assert,eMove:!0})}):c.flatten2(t.ranges.map(function(e){return n[e]})).forEach(function(e){(s[e]=s[e]||[]).push(t)})}),a=c.Set(e.ranges.filter(function(e){return!!e[1]})),t.ranges=a,Object.keys(s).forEach(function(e){var r=s[e],a=[];o.forEach(function(t){t.to.forEach(function(e){(t.eMove||~r.indexOf(t))&&a.push({to:e,action:t.action,assert:t.assert,eMove:t.eMove})})}),s[e]=a}),delete t.trans,delete t.eMoveStates}),this.router=i,this.accepts=r}accept(e){return this.accepts.hasOwnProperty(e)}assertDFA(){for(var e,t=this.router,r=Object.keys(t),a=0,o=r.length;a<o;a++){if(1<(e=t[r[a]]).eMove.length)throw new Error("DFA Assertion Fail!\nFrom state `"+r[a]+"` can goto to multi ε-move states!");for(var s=e.charMove,n=Object.keys(s),c=0,i=n.length;c<i;c++)if(1!==s[n[c]].length)throw _auxKit.log(s),new Error("DFA Assertion Fail!\nFrom state `"+r[a]+"` via charset `"+n[c]+"` can goto to multi states!");if(n.length&&e.eMove.length)throw new Error("DFA Assertion Fail!\nFrom state `"+r[a]+"` can goto extra ε-move state!")}return!0}input(e,t,F){var x=this;return function e(t,r,a,o,s){e:for(;;){var n,c,i,h=x.router[a];if(!h)break;for(var f,u,l=h.eMove,p=h.charMove,v=r<t.length?(n=t[r],p.hasOwnProperty(n)?p[n]:(h=x._escapeChar(h.ranges,n))?p[h]:l):l,g=o.length,M=s,m=0,E=v.length;m<E;m++){if(c=(u=v[m]).eMove?0:1,s=M,o.splice(0,o.length-g),g=o.length,u.assert){if(!1===(f=u.assert(o,n,r,a,t)))continue;"number"==typeof f&&(r+=f,s+=f)}if(u.action&&(o=u.action(o,n,r,a,t)||o),s=u.eMove?s:r,F&&_auxKit.log(n+":"+a+">"+u.to),m===E-1){r+=c,a=u.to;continue e}if((u=e(t,r+c,u.to,o,s)).acceptable)return u;i=u}if(i)return i;break}return{stack:o,lastIndex:s,lastState:a,acceptable:x.accept(a)}}(e,t=t||0,"start",[],t-1)}_aux_escapeChar(e,t){var r=t[0];return e>t[1]?1:e<r?-1:0}_escapeChar(e,t){return!!~(t=e.indexOf(t,this._aux_escapeChar))&&e[t]}_expandNames(e){e.accepts=e.accepts.split(",");for(var t,r,a,o=e.trans,s=o.length;s--;)r=(a=(t=o[s])[0].split(">"))[0].split(","),a=a[1].split(","),o[s]={from:r,to:a,charset:t[1],action:t[2],assert:t[3]};return e.compact=!1,e}}