function EditorAdvance(e={}){let h=[{date:Date.now(),zActions:1,name:"init"}],y=0,k=1e4,p=[],u=[],t=e.$containerEditor,c=t.querySelector(".input-carets"),f=t.querySelector(".input-selects"),v=e.$inputRegex,m=e.$syntaxRegex,i=c.parentElement,N=t.querySelector("#editor-input"),x=void 0,r=e.processInput,n=(e.debugInputClass&&((x=document.createElement("div")).classList.add(e.debugInputClass),i.appendChild(x)),{});const o=()=>{c.timeoutBlink&&clearTimeout(c.timeoutBlink),c.classList.remove("blink"),c.timeoutBlink=window.setTimeout(()=>{c.classList.add("blink")},500)},l=()=>{let e=window.getComputedStyle(document.documentElement),t=e.getPropertyValue("--font-size");return parseFloat(t.substring(0,t.length-2))},g=e=>{if(e.hasOwnProperty("charWidth")&&e.charWidth)return e.charWidth;let t=document.createElement("span");t.innerText="0",t.style.opacity="0",e.appendChild(t);var n=t.getBoundingClientRect().width;return t.remove(),e.charWidth=n},w=(e=0)=>(0===e&&(e=l()),n.hasOwnProperty(e)||(n[e]=g(m)),n[e]),C=(e=0)=>{0===e&&(e=l());let t=window.getComputedStyle(document.documentElement);return e*parseFloat(t.getPropertyValue("--line-height-ratio"))},F=(n,r,e=!1)=>{var o=Array.from(c.children);let i;for(let t=0;t<o.length;t++){let e=o[t];if(parseInt(e.style.getPropertyValue("--pos-char"))===n&&parseInt(e.style.getPropertyValue("--pos-line"))===r){i=e;break}}return!i||e?((i=document.createElement("span")).classList.add("caret"),c.appendChild(i)):(c.removeChild(i),i=void 0),i},K=e=>{var t,n=C(),r=v.getBoundingClientRect();f.innerHTML="";for(t of e)($caretSelection=document.createElement("span")).classList.add("caret-selection"),$caretSelection.style.setProperty("--pos-x",t.x-r.x),$caretSelection.style.setProperty("--pos-y",t.y-r.y),$caretSelection.style.setProperty("--size-width",t.width),$caretSelection.style.setProperty("--size-height",n),f.append($caretSelection)},s=(n,r,o=void 0)=>{var i=n,a=r;if(0===n&&0===r){let e=document.createRange(),t=window.getSelection();t.removeAllRanges(),e.setStart(o,n),e.setEnd(o,r),t.addRange(e)}else{n=Math.min(o.innerText.length,n),r=Math.min(o.innerText.length,r);var[l,n]=S(n,o),[s,r]=S(r,o);n=Math.min(o.innerText.length,n),r=Math.min(o.innerText.length,r);let e=document.createRange(),t=window.getSelection();t.removeAllRanges(),a<i?(e.setStart(s,r),e.setEnd(l,n),e.collapse(!1),t.addRange(e),t.extend(s,r)):(e.setStart(l,n),e.setEnd(s,r),t.addRange(e))}},d=(e,t,n,r)=>{var o,[e,t,n]=((e,t,n,r)=>{var[e,t,n,r]=T({x:e,y:t},{x:n,y:r}),[e,t]=E(e,t,n,r);return[e,t,t<e]})(e,t,n,r);return r=e,o=t,n&&(n=r,r=t,o=n),s(r,o,$toNode=v),[e,t]},S=(t,e)=>{if(3===e.nodeType)return[e,t];var n=e.childNodes;let r=0,o=0,i=void 0;for(let e=0;e<n.length;e++){if(i=n[e],t<=(o+=i.textContent.length)){if(t-r>i.childNodes.length)return S(t-r,i);if(0<i.childNodes.length)return S(t-r,i);break}r+=i.textContent.length}return[i,t-r]},P=e=>{let t=0,n=0,r=!1;if("TEXTAREA"===e.nodeName)t=e.selectionStart,n=e.selectionEnd,r="backward"===e.selectionDirection;else if(void 0!==window.getSelection){const i=window.getSelection();if(0!==i.rangeCount){var o=i.anchorNode.compareDocumentPosition(i.focusNode);r=!1,(!o&&i.anchorOffset>i.focusOffset||o===Node.DOCUMENT_POSITION_PRECEDING)&&(r=!0);const a=i.getRangeAt(0),l=a.cloneRange(),s=(l.selectNodeContents(e),l.setEnd(a.startContainer,a.startOffset),t=l.toString().length,a.cloneRange());s.selectNodeContents(e),s.setEnd(a.endContainer,a.endOffset),n=s.toString().length}}return r?[n,t]:[t,n]},b=()=>Array.from(c.children),E=(t,e,n,r)=>{0===u.length&&M();var o=w();let i=0,a=0;for(let e=0;e<u.length;e++){var l=u[e],l=parseInt((l.width+2)/o);e<t&&(i+=l),e<n&&(a+=l)}return i+=e,a+=r,[i,a]},L=(e,t)=>{0===u.length&&M();var n=w();let r=0,o=Math.min(e,v.innerText.length),i=0,a=Math.min(t,v.innerText.length),l=!0,s=!0;for(let e=0;e<u.length;e++){var d=u[e],d=parseInt((d.width+2)/n);o>d&&l?(o-=d,r++):l=!1,a>d&&s?(a-=d,i++):s=!1}return[r,o,i,a]},R=(e,t)=>{var n=l(),r=C(n),n=w(n),o=v.getBoundingClientRect();return caretPosX=n*t+o.x,caretPosY=r*e+o.y,[caretPosX,caretPosY]},T=(e,t)=>{var n=g(m),r=C(),o=v.getBoundingClientRect();let i=parseInt((e.y-o.y)/r),a=parseInt((t.y-o.y)/r),l=e,s=t,d=!1;return i===a&&e.x>t.x&&(s=e,l=t,d=!0),i>a&&(s=e,l=t,r=i,i=a,a=r,d=!0),e=i,t=a,[e,Math.round((l.x-o.x)/n),t,Math.round((s.x-o.x)/n),d]},M=()=>{var e,t,n,r=v.getBoundingClientRect();let o=window.getSelection(),i=void 0,a=(1<=o.rangeCount&&(i=o.getRangeAt(0)),o.selectAllChildren(m),Array.from(o.getRangeAt(0).getClientRects())),l=(o.removeAllRanges(),i&&o.addRange(i),a=a.sort((e,t)=>e.y-t.y),u=[],window.newLines={},0===a.length&&a.push({bottom:r.bottom,height:r.height,left:r.left,right:r.left,top:r.top,width:0,x:r.x,y:r.y}),a[0].y),s={bottom:0,height:0,left:1/0,right:0,top:1/0,width:0,x:1/0,y:0};for(d in a){var d=parseInt(d),g=a[d];g.y>l&&(l=g.y,s.width=s.right-s.left,s.height=s.bottom-s.top,u.push(s),s={bottom:0,height:0,left:1/0,right:0,top:1/0,width:0,x:1/0,y:0}),s={bottom:Math.max(g.bottom,s.bottom),left:Math.min(g.left,s.left),right:Math.max(g.right,s.right),top:Math.min(g.top,s.top),x:Math.min(g.x,s.x),y:Math.max(g.y,s.y)},d>=a.length-1&&(s.width=s.right-s.left,s.height=s.bottom-s.top,u.push(s))}for(e of u)e.y-=r.y,e.x-=r.x,e.top-=r.top,e.bottom=e.height+e.top,e.left-=r.left,e.right=e.width+e.left;if("\n\n"===v.textContent.slice(-2)&&(t=u[u.length-1],n=u[0],u.push({bottom:t.bottom+n.top+t.height,height:t.height,left:t.left,right:t.left,top:t.bottom+n.top,width:0,x:t.x,y:t.bottom+n.top})),void 0!==x){x.innerHTML="";for(var c of u){let e=document.createElement("span");e.style.width=c.width+"px",e.style.height=c.height+"px",e.style.left=c.left+"px",e.style.top=c.top+"px",e.style.position="absolute",e.style.background="#0000ff66",e.classList.add("boxSel"),x.appendChild(e)}}},A=(e,t=!1)=>{0===u.length&&M();let n;for(var r in u)e>=(r=u[r]).y&&(n=r);return n&&(n=Object.keys(n).reduce((e,t)=>(e[t]=n[t],e),{}),t&&(t=v.getBoundingClientRect(),n.y+=t.y,n.x+=t.x,n.top+=t.top,n.bottom+=t.top,n.left+=t.left,n.right+=t.left)),n},D=()=>{var e;for(e of b()){t=e;var[t,n]=[parseFloat(t.style.getPropertyValue("--offset-start")),parseFloat(t.style.getPropertyValue("--offset-end"))],[t,n,r,o]=L(t,n);H(e,r,o,t,n,o)}$()},I=(e,{$caret:t=void 0,ctrlKey:n=!1,wheelKey:r=!1,dragStyle:o=!1,resetFirst:i=!1})=>{var a,l=v.getBoundingClientRect();return e={x:e.x-l.x,y:e.y-l.y},void 0!==(l=A(e.y))&&(e={x:Math.min(e.x,l.x+l.width),y:l.y+l.height/2},l=g(m),a=C(),a=parseInt(e.y/a),l=Math.round(e.x/l),t=V(a,l,{$caret:t,ctrlKey:n,wheelKey:r,dragStyle:o,resetFirst:i})),[e,t]},V=(t,n,{$caret:r=void 0,ctrlKey:o=!1,dragStyle:i=!1,resetFirst:e=!1})=>{var a,l=void 0===r;let s=void 0,d=void 0;if(void 0===r){let e=b();if(0===e.length||o&&!i||i)r=F(n,t,i);else{r=e.pop();for(var g of e)c.removeChild(g);s=t,d=n}}return void 0!==r&&(o=parseInt(r.style.getPropertyValue("--pos-char"))||n,a=parseInt(r.style.getPropertyValue("--pos-line"))||t,s=l||e?t:s,d=l||e?n:d,l=a===t?n:o,H(r,t,n,s,d,l),i||$()),r},$=()=>{var e,t=b(),n=C();let r=[];f.innerHTML="";for(e of t){var o=parseInt(e.style.getPropertyValue("--fpos-line")),i=parseInt(e.style.getPropertyValue("--pos-line")),[a,l]=R(o,parseInt(e.style.getPropertyValue("--fpos-char"))),[s,d]=R(i,parseInt(e.style.getPropertyValue("--pos-char")));if(i!==o){let e=!1;i<o&&(e=!0);var g=A(o*n+n/2,absolutePos=!0),c=A(i*n+n/2,absolutePos=!0);if(g&&c&&(e?(r.push({top:l,bottom:l+n,height:n,width:a-g.left,left:g.left,right:a,x:g.left,y:l}),r.push({bottom:c.bottom,top:c.top,height:n,width:c.right-s,left:s,right:c.right,x:s,y:c.y})):(r.push({top:g.top,bottom:g.bottom,height:n,width:g.right-a,left:a,right:g.right,x:a,y:g.y}),r.push({top:c.top,bottom:c.bottom,height:n,width:s-c.left,left:c.left,right:s,x:c.x,y:c.y}))),0<Math.abs(i-o))for(let e=Math.min(o,i)+1;e<Math.max(o,i);e++){var h=A(e*n+n/2,absolutePos=!0);h&&r.push(h)}}else a!==s&&(l=s<a,r.push({top:d,bottom:d+n,height:n,width:Math.abs(s-a),left:l?s:a,right:l?a:s,x:l?s:a,y:d}))}K(r)},H=(e,t,n,r,o,i)=>{e.style.setProperty("--pos-line",t),e.style.setProperty("--pos-char",n),void 0!==r&&e.style.setProperty("--fpos-line",r),void 0!==o&&e.style.setProperty("--fpos-char",o),e.style.setProperty("--max-pos-char",i);var i=r||parseFloat(e.style.getPropertyValue("--fpos-line")),r=o||parseFloat(e.style.getPropertyValue("--fpos-char")),o=t,t=n,[n,i]=E(i,r,o,t);e.style.setProperty("--offset-start",n),e.style.setProperty("--offset-end",i)},X=e=>{var t=parseInt(e.style.getPropertyValue("--pos-char")),n=parseInt(e.style.getPropertyValue("--pos-line")),r=parseFloat(e.style.getPropertyValue("--fpos-char")),e=parseFloat(e.style.getPropertyValue("--fpos-line")),o=v.getBoundingClientRect(),i=g(m),a=C();return[{x:r*i+o.x,y:e*a+o.y},{x:t*i+o.x,y:n*a+o.y}]},O=(e,t)=>{var n=Array.from(f.children);let r;var o=v.getBoundingClientRect();for(r of n){var i=parseFloat(r.style.getPropertyValue("--pos-x"))+o.x,a=parseFloat(r.style.getPropertyValue("--pos-y"))+o.y,l=parseFloat(r.style.getPropertyValue("--size-width")),s=parseFloat(r.style.getPropertyValue("--size-height"));if(i<e&&e<i+l&&a<t&&t<a+s)return[r,{sx:i,sy:a,ex:i+l,ey:a+s}]}return[void 0,{sx:0,sy:0,ex:0,ey:0}]},z=(e,t)=>{v.internalDrag&&!getSelection().isCollapsed&&B(v.ownerDocument,"delete",{keepZAction:!1});var n,r=v.dragCaret.getBoundingClientRect(),[r,o]=(d(r.x,r.y,r.x,r.y),B(v.ownerDocument,"insertHTML",{value:e,nameZAction:"DroppedElement"}),u=[],P(v)),r=(n=r-e.length,s(n,o,$toNode=m),(()=>{var t=window.getSelection().getRangeAt(0).getClientRects();if(C(),0!==t.length)return{x:t[0].x,y:t[0].y,width:t[0].width,height:t[0].height};{t=v;let e={x:0,y:0,width:1,height:C()};if("TEXTAREA"===t.nodeName)prePosition=t.selectionStart,postPosition=t.selectionEnd,t.selectionDirection;else if(void 0!==window.getSelection){const i=window.getSelection();if(0!==i.rangeCount){const a=i.getRangeAt(0);var[n,r]=P(t),[n,o]=S(n,t),[r,t]=S(r,t);a.setStart(n,o),a.setEnd(r,t),e=a.getClientRects()[0]}}return{x:e.x,y:e.y,width:e.width,height:e.height}}})()),e=(c.contains(v.dragCaret)&&c.removeChild(v.dragCaret),v.dragging=!1,v.dragCaret=void 0,v.internalDrag=!1,v.textSelection={sx:0,sy:0,ex:0,ey:0},I({x:r.x,y:r.y+r.height/2},{}),Array.from(c.children).slice(-1)[0]);I({x:r.x+r.width,y:r.y+r.height/2},{$caret:e}),i.focus()},Y=e=>{var t=m.getBoundingClientRect();(e=e.target.getBoundingClientRect()).left>=t.left&&e.right<=t.right&&e.top>=t.top&&e.bottom<=t.bottom||(i.blur(),v.dragging&&v.dragCaret&&(c.contains(v.dragCaret)&&c.removeChild(v.dragCaret),v.dragging=!1,v.dragCaret=void 0,v.internalDrag=!1))},U=e=>{c.innerHTML="",f.innerHTML="";for(var t of e){var[n,r,o,i]=L(t.startOffset,t.endOffset),n=V(n,r,{ctrlKey:!0});t.startOffset!==t.endOffset&&V(o,i,{$caret:n,ctrlKey:!0})}},W=(t,{showUI:n=!1,value:r=null})=>{if(0<y){var e=h[y].caretsOffset;for(let e=0;e<h[y].zActions;e++)t.execCommand("undo",n,r);--y,U(e)}},Z=(t,{showUI:n=!1,value:r=null})=>{if(y<h.length-1){y+=1;for(let e=0;e<h[y].zActions;e++)t.execCommand("redo",n,r);var e=h[y].caretsOffset;U(e)}},B=(n,r,{showUI:o=!1,value:e=null,keepZAction:t=!0,nameZAction:i=""})=>{if("undo"===r)return W(n,{showUI:o,value:e});if("redo"===r)return Z(n,{showUI:o,value:e});if(n.execCommand(r,o,e),""===i&&(i=r),t){var l;let e=[];for(l of b()){var[s,d]=X(l),[s,d,g,c]=T(s,d),[s,d]=E(s,d,g,c);e.push({startOffset:s,endOffset:d})}n=[...p,{commandName:r}],p=[],y+=1,o=h[0];let t=0;h.length>=k&&(t=1),a=[o,...h.slice(t+1,y)],y=h.length,h.push({comands:n,date:Date.now(),zActions:n.length,name:i,caretsOffset:e})}else p.push({commandName:r})};{m.addEventListener("mousedown",n=>{if(i.classList.contains("new-advance")){v.mousedown=!0,v.dragging&&(c.contains(v.dragCaret)&&c.removeChild(v.dragCaret),v.dragging=!1,v.dragCaret=void 0,v.internalDrag=!1,v.textSelection={sx:0,sy:0,ex:0,ey:0});let[e,t]=O(n.clientX,n.clientY);var r;void 0!==e?(r=parseFloat(e.style.getPropertyValue("--size-height")),v.textSelection={sx:t.sx,sy:t.sy+r/2,ex:t.ex,ey:t.ey-r/2},v.selecting=!1,v.internalDrag=!0,v.initSelecting=!0):(o(),v.initSelecting=!0,I({x:n.clientX,y:n.clientY},{$caret:void 0,ctrlKey:n.ctrlKey}))}},!0),m.addEventListener("mousemove",n=>{if(0===n.which)v.selecting=!1;else if(v.initSelecting&&!v.internalDrag&&(v.initSelecting=!1,v.selecting=!0),v.selecting&&(e=c.lastChild,I({x:n.clientX,y:n.clientY},{$caret:e,wheelKey:2===n.which})),(v.internalDrag||v.dragging)&&1===n.which){var[e]=O(n.clientX,n.clientY);if(void 0===e){v.dragCaretPos={x:n.clientX,y:n.clientY};let[e,t]=I(v.dragCaretPos,{$caret:v.dragCaret,ctrlKey:!1,dragStyle:!0});v.dragCaretPos=e,t.classList.add("drag"),v.dragCaret=t}else c.contains(v.dragCaret)&&c.removeChild(v.dragCaret),v.dragging=!0,v.dragCaret=void 0,v.initSelecting=!1}},!0),m.addEventListener("mouseup",e=>{var t,n;v.selecting=!1,v.mousedown=!1,v.dragging?([n,t]=O(e.clientX,e.clientY),void 0===n?(f.innerHTML="",window.getSelection().removeAllRanges(),d(v.textSelection.sx,v.textSelection.sy,v.textSelection.ex,v.textSelection.ey),n=window.getSelection().toString(),z(n)):(v.dragging=!1,v.dragCaret=void 0,v.internalDrag=!1,v.textSelection={sx:0,sy:0,ex:0,ey:0})):!e.ctrlKey&&v.initSelecting?(v.initSelecting=!1,v.internalDrag=!1,o(),I({x:e.clientX,y:e.clientY},{$caret:void 0})):v.initSelecting=!1},!0),m.addEventListener("dragstart",function(e){e.preventDefault()},!1),i.addEventListener("mouseleave",e=>{v.dragging&&Y(e)},!1),m.addEventListener("dragover",e=>{e.preventDefault(),v.dragCaretPos={x:e.clientX,y:e.clientY};let[t,n]=I(v.dragCaretPos,{$caret:v.dragCaret,ctrlKey:!1,dragStyle:!0});v.dragCaretPos=t,n.classList.add("drag"),v.dragCaret=n},!1),m.addEventListener("dragenter",e=>{var t=m.getBoundingClientRect();(e=e.target.getBoundingClientRect()).left>=t.left&&e.right<=t.right&&e.top>=t.top&&e.bottom<=t.bottom&&(v.dragging||(v.selecting=!1,c.innerHTML="",f.innerHTML="",v.dragging=!0,v.mousedown&&(v.internalDrag=!0)),i.focus())},!1),m.addEventListener("dragleave",Y,!1),m.addEventListener("drop",function(e){e.preventDefault(),e=e.dataTransfer.getData("Text"),v.internalDrag&&(f.innerHTML="",window.getSelection().removeAllRanges(),d(v.textSelection.sx,v.textSelection.sy,v.textSelection.ex,v.textSelection.ey)),z(e)},!1);var e=e=>{i.editing||(c.timeoutBlink&&clearTimeout(c.timeoutBlink),c.classList.remove("blink"),c.classList.add("nofocus"),f.classList.add("nofocus"))},q=()=>{i.classList.contains("new-advance")&&(c.classList.remove("nofocus"),f.classList.remove("nofocus"),o())};i.addEventListener("blur",e),m.addEventListener("blur",e),i.addEventListener("focus",q),m.addEventListener("focus",q),m.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),B(m.ownerDocument,"insertText",{value:"\n"}))," "===e.key&&(e.preventDefault(),B(m.ownerDocument,"insertText",{value:" "}))}),m.addEventListener("input",e=>{v.innerText=m.innerText;var[t,n]=P(m);r(),s(t,n,m),u=[],M(),D()}),v.addEventListener("input",e=>{r(),u=[],M(),D()});const j=new ResizeObserver(e=>{u=[],M(),D()});j.observe(N)}const _=()=>{c.innerHTML="",f.innerHTML=""};return{cleanEditor:_,updateEditor:()=>{_(),M()}}}